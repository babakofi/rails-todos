
Object.extend(String.English,{});Todos=SC.Object.create({server:SC.Server.create({prefix:['Todos']}),FIXTURES:[]});function main(){SC.page.awake();Todos.serverController.loadTasks();};require('core');Todos.tasksController=SC.ArrayController.create({destroyOnRemoval:YES,addTask:function(){var task=Todos.Task.newRecord({title:'Untitled',order:this.get('length')});this.pushObject(task);var listView=SC.page.getPath('todos.taskListScrollView.taskList');var itemView=listView.itemViewForContent(task);itemView.beginEditing();},deleteTask:function(){var tasks=this.get('selection');this.beginPropertyChanges();var idx=tasks.get('length');while(--idx>=0){var task=tasks.objectAt(idx);this.removeObject(task);}
this.endPropertyChanges();},canDeleteTask:function(){var sel=this.get('selection');return(sel!=null)&&(sel.get('length')>0);}.property('selection'),enumerableContentDidChange:function(){arguments.callee.base.apply(this,arguments);var content=Array.from(this.get('content'));var len=content.get('length');for(var idx=0;idx<len;idx++){var task=content.objectAt(idx);if(task.get('order')!==idx)task.set('order',idx);}}});require('core');Todos.Task=SC.Record.extend({recordDidChange:function(){if(!this.get('isCommitting')){if(this.get('guid').slice(0,1)==='@'){if(this._tried>2&&(this.get('title')!=='Untitled')){Todos.serverController.createRecord(this);}else this._tried++;}else Todos.serverController.commitRecord(this);}
arguments.callee.base.apply(this,arguments);},isCommitting:NO,_tried:0,recordDidDestroy:function(){if(!this.get('isDeleted'))return;if(this._wasDestroyed)return;this._wasDestroyed=YES;if(this.get('guid').slice(0,1)!=='@'){Todos.serverController.destroyRecord(this);}}.observes('isDeleted')});require('core');Todos.serverController=SC.Object.create({loadTasks:function(){new Ajax.Request('/tasks.json',{method:'get',onSuccess:this._loadTasksDidSucceed,onFailure:this._loadTasksDidFail});},_loadTasksDidSucceed:function(transport){var json=transport.responseJSON;if(!json)return this._loadTasksDidFail(transport);var records=json.content;records=SC.Store.updateRecords(records,SC.Store,Todos.Task);records=records.sort(function(a,b){var orderA=a.get('order');var orderB=b.get('order');if(orderA===orderB){var titleA=a.get('title');var titleB=b.get('title');return(titleA<titleB)?-1:(titleA>titleB)?1:0;}else return(orderA<orderB)?-1:(orderA>orderB)?1:0;});Todos.tasksController.set('content',records);},_loadTasksDidFail:function(){console.log('oops. failed!');},createRecord:function(rec){var req=new Ajax.Request('/tasks.json',{method:'post',onSuccess:this._createRecordDidSucceed,onFailure:this._createRecordDidFail,contentType:'application/json',postBody:Object.toJSONString({content:rec.get('attributes')})});req.record=rec;rec.set('isCommitting',YES);},_createRecordDidSucceed:function(transport){var guid=transport.getHeader('Location');var record=transport.request.record;transport.request.record=null;SC.Store.relocateRecord(record.get('guid'),guid,record);record.set('guid',guid);record.set('newRecord',NO);record.set('isCommitting',NO);},_createRecordDidFail:function(transport){console.log("oops failed!");transport.request.record.set('isCommitting',NO);transport.request.record=null;},commitRecord:function(rec){var req=new Ajax.Request(rec.get('guid'),{method:'put',onSuccess:this._commitRecordDidSucceed,onFailure:this._commitRecordDidFail,contentType:'application/json',postBody:Object.toJSONString({content:rec.get('attributes')})});req.record=rec;rec.set('isCommitting',YES);},_commitRecordDidSucceed:function(transport){transport.request.record.set('isCommitting',NO);transport.request.record=null;},_commitRecordDidFail:function(transport){console.log("oops failed!");transport.request.record.set('isCommitting',NO);transport.request.record=null;},destroyRecord:function(rec){var req=new Ajax.Request(rec.get('guid'),{method:'delete'});}});